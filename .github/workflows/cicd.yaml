# todo
# feature, hotfix - PR ìƒì„±, ë™ê¸°í™” => ìœ ë‹› í…ŒìŠ¤íŠ¸ (0)
# feature, hotfix - PR ë‹«í˜
# ã„´ feature, hoxfix ë¸Œëœì¹˜ í™•ì¸
# ã„´ featureë©´ minor ë²„ì „ ì—…ë°ì´íŠ¸, hotfixë©´ path ë²„ì „ ì—…ë°ì´íŠ¸ (yarn version)
# main - push => ìœ ë‹› í…ŒìŠ¤íŠ¸
# publish - push => ìœ ë‹› í…ŒìŠ¤íŠ¸ (0) => íŒ¨í‚¤ì§€ í¼ë¸”ë¦¬ì‹œ (yarn publish)

name: CI/CD
on:
  push:
    branches: [main, publish]
  pull_request:
    types: [opened, synchronize, closed]

jobs:
  # unit-test:
  #   if: github.event.pull_request.state != 'closed'
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     - name: Set up Node.js
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: 21.4.0
  #     - name: Enable Corepack
  #       run: corepack enable
  #     - name: Install dependencies
  #       run: yarn install --frozen-lockfile
  #       shell: bash
  #     - name: Use Unit Test Action
  #       uses: ./.github/actions/unit-test
  package-version-update:
    if: github.event.pull_request.state == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 21.4.0
      - name: Enable Corepack
        run: corepack enable
      - name: Install dependencies
        run: yarn install --frozen-lockfile
        shell: bash
      - name: Determine version bump based on branch
        run: |
          if [[ "${{ github.head_ref }}" == feature/* ]]; then
            echo "versionLevel=minor" >> $GITHUB_ENV
          elif [[ "${{ github.head_ref }}" == hotfix/* ]]; then
            echo "versionLevel=patch" >> $GITHUB_ENV
          else
            echo "versionLevel=none" >> $GITHUB_ENV
          fi
      - name: Print package version
        run: echo versionLevel ${{ env.versionLevel }}
      - name: Update package version
        run: yarn version -d ${{ env.versionLevel }}
      - name: Apply paackge version
        run: yarn version apply
      - name: Set Git Author Config
        run: |
          git config --global user.name "${{ secrets.AUTHOR_NAME }}"
          git config --global user.email "${{ secrets.AUTHOR_EMAIL }}"
      - name: Stage changes
        run: git commit -am "ğŸ“¦ íŒ¨í‚¤ì§€ ë²„ì „ ì—…ë°ì´íŠ¸ $(node -p "require('./package.json').version")"

      - name: Push changes and tags
        run: |
          git push
          git push --follow-tags  # ì»¤ë°‹ê³¼ íƒœê·¸ í‘¸ì‹œ
